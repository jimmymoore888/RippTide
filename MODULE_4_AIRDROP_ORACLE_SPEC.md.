# Module 4 Spec (Airdrop Oracle v0)
## Individualized Top-Asset Airdrop Engine (On-Chain Ready)

**Canonical Name:** M4-AOE — Airdrop Oracle Engine  
**Host Module:** Module 4  
**Doctrine Context:** Near-Intersect token profiles may include Module 4 (unless excluded by profile rules).  
**Primary Objective:** Perform **individualized** airdrops of top crypto assets to each participant using a **deterministic, auditable** oracle-fed process.

**Hard Constraint (Locked):** **35% of the airdropped allocation MUST be Large Caps.**

---

## 1) Problem Statement (Why Module 4 Exists)
Airdrops are often:
- opaque (“trust me” lists),
- manipulable (sybils, hidden criteria),
- non-reproducible (no deterministic reconstruction),
- disconnected from real diversification goals.

Module 4 exists to make airdrops:
- **deterministic**
- **auditable**
- **repeatable**
- **policy-bound** (Large Cap floor)
- **individualized** (per-user asset basket)

---

## 2) Design Principles (Hard Constraints)
**DP-01 Deterministic Reconstruction:** Every airdrop must be reconstructable from on-chain events + a committed snapshot hash.  
**DP-02 Oracle-Minimized Trust:** Oracles provide data; the contract enforces constraints and rejects invalid submissions.  
**DP-03 Individualization:** Each recipient’s basket is computed per recipient (not a single global list).  
**DP-04 Large Cap Floor:** ≥ 35% of allocation MUST be Large Caps (defined by policy list).  
**DP-05 Sybil Resistance Hooks:** Include eligibility gates and/or proof hooks, even if v0 uses simple allowlists.  
**DP-06 Non-Inflationary Compatibility:** Module 4 MUST NOT require minting beyond the profile’s fixed supply discipline (Module 1 constraints apply system-wide).

---

## 3) Definitions
### 3.1 “Top Assets”
“Top assets” are defined as the top-N assets by an agreed ranking metric (typically market cap, but policy may switch to liquidity-weighted cap).

**Default:** N = 17 (locked by your prior definition).

### 3.2 “Large Caps”
Large Caps are defined by a maintained allowlist / class list (e.g., BTC, ETH, and other high-cap assets), updated only by authorized governance/oracle rule.

**Large Cap Floor:** `large_cap_allocation_pct >= 0.35`

### 3.3 Recipient “Individualization”
Individualization is achieved by:
- a deterministic function using recipient identity + epoch seed,
- plus a top-asset list input for that epoch,
- optionally combined with recipient preference weights.

---

## 4) Actors
- **Recipient:** eligible address receiving individualized basket.
- **Oracle Feeder:** off-chain agent(s) that submit top-asset snapshots and classifications.
- **Verifier:** optional agent(s) that attest to oracle data validity (can be merged with oracle in v0).
- **Governance Authority:** entity permitted to rotate oracle keys, update policy lists, and freeze/unfreeze epochs.

---

## 5) Data Model

### 5.1 Snapshot Record (per epoch)
- `epoch_id: u64`
- `snapshot_time: u64` (unix)
- `top_assets: [AssetId; 17]`
- `large_cap_set_hash: bytes32` (hash of the Large Cap allowlist/class file)
- `ranking_method: bytes32` (identifier string/hash, e.g., "mcap_usd")
- `snapshot_hash: bytes32` (commitment to full snapshot payload)
- `oracle_signature: bytes` (or equivalent auth proof)

### 5.2 AssetId (canonical)
- `chain: enum` (NEAR / EVM / etc. if cross-chain; v0 can keep symbolic)
- `symbol: string`
- `ref: string` (canonical identifier: contract address, CMC ID, etc.)

### 5.3 Recipient Airdrop Plan
- `recipient: AccountId`
- `epoch_id: u64`
- `basket_assets: [AssetId; K]`
- `basket_weights: [u16; K]` (bps weights; sum = 10,000)
- `allocation_amount: u128` (token units or budget units)

---

## 6) State Machine

### 6.1 Epoch State
- `EPOCH_NONE`
- `EPOCH_PROPOSED`
- `EPOCH_COMMITTED`
- `EPOCH_DISTRIBUTING`
- `EPOCH_FINALIZED`
- `EPOCH_ABORTED`

**Transitions**
- `propose_epoch`: NONE → PROPOSED  
- `commit_epoch`: PROPOSED → COMMITTED  
- `start_distribution`: COMMITTED → DISTRIBUTING  
- `finalize_epoch`: DISTRIBUTING → FINALIZED  
- `abort_epoch`: PROPOSED/COMMITTED/DISTRIBUTING → ABORTED (restricted + reason)

### 6.2 Recipient Claim State (per epoch)
- `UNSET`
- `ELIGIBLE`
- `CLAIMED`
- `REJECTED`

---

## 7) Deterministic Basket Generation

### 7.1 Seed
For each epoch:
- `epoch_seed = H(snapshot_hash || epoch_id || module_profile_seed)`

For each recipient:
- `recipient_seed = H(epoch_seed || recipient_account_id)`

Where `H` is a cryptographic hash.

### 7.2 Basket Selection (default)
- Always include **Large Cap slice** determined by policy
- Remaining slice selected from `top_assets` via deterministic PRNG stream derived from `recipient_seed`

### 7.3 Weighting (default)
Split weights into two partitions:
- `W_LC = max(3500, policy_large_cap_floor_bps)`  
- `W_REST = 10000 - W_LC`

Within Large Caps:
- deterministic selection from Large Cap subset of `top_assets`
- weights can be equal-weighted or rank-weighted (policy)

Within Rest:
- deterministic selection from non-large-cap subset
- weights equal-weighted (v0 default)

**Invariant:** `sum(weights) == 10000` and Large Caps weights sum ≥ 3500 bps.

---

## 8) Eligibility Rules (v0)
Module 4 supports multiple eligibility modes:

### Mode A (Allowlist)
- Oracle submits list hash; contract verifies membership proofs (Merkle proof).

### Mode B (On-chain Criteria)
- Must hold token X, or must have interacted with factory, etc.

### Mode C (Hybrid)
- Allowlist + criteria.

**v0 Default:** Mode A (Allowlist with Merkle proofs) for simplicity and auditability.

---

## 9) Distribution Models
Module 4 is compatible with these distribution modes:

### Model 1: “Token Budget” Distribution
- The contract allocates a fixed amount of the issued token to recipients.
- Basket specifies intended diversification targets (informational or for off-chain routing).

### Model 2: “Treasury Basket Routing” (optional future)
- If treasury holds diversified assets, contract can route payouts across those assets.

**v0 Default:** Model 1 (Token Budget) with deterministic basket metadata emitted for transparency.

---

## 10) Global Invariants (Must Always Hold)
- **INV-M4-01 Top-N Fixed:** `len(top_assets) == 17`
- **INV-M4-02 Snapshot Commit:** `snapshot_hash` must match committed payload
- **INV-M4-03 Oracle Auth:** only authorized oracle(s) can propose/commit epochs
- **INV-M4-04 Large Cap Floor:** `large_cap_weight_bps >= 3500`
- **INV-M4-05 Determinism:** basket generation uses only `snapshot_hash`, `epoch_id`, profile seed, and recipient id
- **INV-M4-06 One Claim:** recipient can claim at most once per epoch
- **INV-M4-07 Supply Discipline Compatibility:** payouts cannot exceed allocated airdrop budget for the epoch

---

## 11) Interface (Functions)

### 11.1 Oracle / Governance
- `set_oracle(oracl_acc: AccountId) -> bool` *(restricted)*
- `set_policy_large_cap_floor_bps(bps: u16) -> bool` *(restricted; must be >= 3500)*
- `set_large_cap_list_hash(hash: bytes32) -> bool` *(restricted)*
- `set_ranking_method(method_id: bytes32) -> bool` *(restricted)*
- `pause_module() -> bool` *(restricted)*
- `unpause_module() -> bool` *(restricted)*

### 11.2 Epoch Lifecycle
- `propose_epoch(epoch_id, snapshot_time, top_assets[17], large_cap_set_hash, ranking_method, snapshot_hash, sig) -> bool`
- `commit_epoch(epoch_id) -> bool`
- `start_distribution(epoch_id) -> bool`
- `finalize_epoch(epoch_id) -> bool`
- `abort_epoch(epoch_id, reason_code) -> bool`

### 11.3 Eligibility + Claims
- `set_eligibility_root(epoch_id, merkle_root: bytes32) -> bool` *(restricted)*
- `check_eligibility(epoch_id, recipient, merkle_proof[]) -> bool`
- `quote_basket(epoch_id, recipient) -> {assets[], weights_bps[]}`
- `claim(epoch_id, merkle_proof[]) -> bool`
  - checks: module not paused, epoch DISTRIBUTING, recipient ELIGIBLE, not CLAIMED
  - action: transfers payout, emits basket metadata event, marks CLAIMED

---

## 12) Abuse Resistance (v0)
- **AR-01 Merkle Eligibility:** avoid sybil sprawl via curated eligibility lists
- **AR-02 One-Claim Enforcement:** one claim per account per epoch
- **AR-03 Epoch Cadence Controls:** prevent rapid oracle churn
- **AR-04 Snapshot Hash Commit:** prevents midstream list tampering
- **AR-05 Pause Switch:** emergency freeze on oracle compromise

---

## 13) Event Log (Audit Reconstruction)
Emit events sufficient to rebuild the full airdrop:

- `EVT_M4_EPOCH_PROPOSED(epoch_id, snapshot_hash, snapshot_time, ranking_method, large_cap_set_hash)`
- `EVT_M4_EPOCH_COMMITTED(epoch_id, snapshot_hash)`
- `EVT_M4_ELIGIBILITY_ROOT_SET(epoch_id, merkle_root)`
- `EVT_M4_DISTRIBUTION_STARTED(epoch_id)`
- `EVT_M4_CLAIM(recipient, epoch_id, payout_amount, basket_assets_hash, basket_weights_hash)`
- `EVT_M4_EPOCH_FINALIZED(epoch_id, total_claims, total_distributed)`
- `EVT_M4_EPOCH_ABORTED(epoch_id, reason_code)`
- `EVT_M4_POLICY_UPDATED(key, value)`

---

## 14) Minimal v0 Test Plan (Pass/Fail)
1. **Top-N Length:** reject snapshots not exactly 17 assets  
2. **Large Cap Floor:** any basket computed must have LC >= 35%  
3. **Commit Integrity:** committed epoch must match snapshot_hash  
4. **Oracle Auth:** non-oracle cannot propose/commit epoch  
5. **Eligibility Proof:** invalid Merkle proof fails eligibility/claim  
6. **One Claim:** second claim in same epoch fails  
7. **Budget Bound:** total distributed cannot exceed epoch allocation  
8. **Determinism:** same inputs produce same basket outputs  
9. **Event Completeness:** epoch + claim events allow full reconstruction

---

## 15) Canonical Placement / File Name
**Recommended file:** `docs/modules/MODULE_4_AIRDROP_ORACLE_SPEC.md`

**Recommended index entry:**
- Module 4 (Airdrop Oracle v0): `docs/modules/MODULE_4_AIRDROP_ORACLE_SPEC.md`
